(function(){"use strict";var a,b;a=jQuery,b=function(){function b(a){var b;this.options=a,b=window.location.hash&&0===window.location.hash.indexOf("share")?window.location.hash.split("-")[1]:null,this.options.comment_type=this.options.comment_type||b,this.initializeModal(),this.initializeTabs(),this.initializeRadioButtons(),this.initializeAttachmentFields(),this.initializeRatingFields(),this.initializeFieldToggler(),this.initializeValidation(),this.initializeVoting(),this.initializeFlagging(),this.initializeTips(),this.initializeFilter(),this.initializeRatingFilter()}return b.prototype.initializeFilter=function(){var b;return b=this,a(".contributions-filter select").on("change",function(){return b.filterContributions(a(this).val())}),a(".js-clear-filters").on("click",function(b){return b.preventDefault(),a(".contributions-filter select").val("").trigger("change")})},b.prototype.initializeRatingFilter=function(){var b;return b=this,a("#reviews .product-rating-details a").on("click",function(c){return c.preventDefault(),a(".contributions-filter select").val("comment_type=review"),b.filterContributions(decodeURIComponent(a(this).attr("href")).split("comments_filter=")[1].split("#")[0])})},b.prototype.filterContributions=function(b){var c;return c=this,a("#contributions-list-title").text(this.options.i18n.loading),a("#contributions-list .contributions-container").empty().addClass("loading"),a.get(this.options.ajax_url,{action:"wc_product_reviews_pro_contributions_list",product_id:this.options.product_id,comments_filter:b},function(b){return a("#contributions-list").html(b),c.hideFlagForms(),c.initializeFieldToggler(),c.initializeTips()}),b?a(".js-clear-filters").show():a(".js-clear-filters").hide()},b.prototype.initializeRadioButtons=function(){return a("#reviews").on("click",".form-contribution input[type='radio']",function(){var b,c;return b=a(this).closest(".form-row"),(c=b.hasClass("validate-required"))?void 0:this.value===b.attr("data-prev-value")?(a(this).prop("checked",!1).trigger("change"),b.attr("data-prev-value","")):b.attr("data-prev-value",this.value)})},b.prototype.initializeTabs=function(){var b;return b=this,this.$contributionTabs=a(".contribution-form-wrapper"),this.options.comment_type&&"contribution_comment"!==this.options.comment_type&&this.activateTab(this.options.comment_type),a(".js-switch-contribution-type").on("click",function(c){return c.preventDefault(),b.activateTab(a(this).attr("href").split("-")[1])})},b.prototype.activateTab=function(b){return this.$contributionTabs.removeClass("active"),this.$contributionTabs.filter("#"+b+"_form_wrapper").addClass("active"),a('.js-switch-contribution-type[href="#share-'+b+'"]').addClass("active").siblings(".active").removeClass("active")},b.prototype.initializeRatingFields=function(){return a("#review_rating_field").each(function(){var b;return b=a('<span class="star-label" data-selected-text="" />'),a(this).append(b),a(this).find("label.checkbox").each(function(){return a(this).hover(function(c){return function(){return b.text(a(c).text())}}(this),function(){return function(){return b.text(b.data("selected-text"))}}(this))}),a(this).find("input").on("change",function(){var c;return c=a(this).siblings('label.checkbox[for="review_rating_'+a(this).val()+'"]').text(),b.text(c).data("selected-text",c)})})},b.prototype.initializeAttachmentFields=function(){var b;return b=this,a(".form-contribution .attachment-url").each(function(){var b,c;return c=a(this).closest("form"),b=c.find(".attachment-file"),b.length?a(this).add(b).prepend('<a href="#" class="toggle-attachment-source"></a>'):void 0}),a(".form-contribution .attachment-type").each(function(){var c,d,e,f,g,h,i;return f=a(this),e=a(this).closest("form"),h=e.find('input[name="comment_type"]').val(),c=f.find("input"),g=e.find(".attachment-url"),d=e.find(".attachment-file"),-1===a.inArray(h,["video","photo"])&&g.hide(),d.hide(),i=function(a){return g.find(".toggle-attachment-source").text(b.options.i18n["attach_"+a+"_file"]),d.find(".toggle-attachment-source").text(b.options.i18n["attach_"+a+"_url"])},c.val()&&i(c.val()),c.on("change",function(){var b,c;return c=this.value,b=a(this).is(":checked"),b&&c?(i(c),"video"===c?(d.hide(),g.find(".toggle-attachment-source").hide()):g.find(".toggle-attachment-source").show(),g.is(":visible")||d.is(":visible")?void 0:g.slideDown("fast")):(g.slideUp("fast"),d.slideUp("fast"))}).each(function(){var c;return c=this.value,a(this).next("label.checkbox").attr("title",b.options.i18n["attach_a_"+c]).addClass("js-tip")}),f.find("label:first-child").hide(),e.find(".toggle-attachment-source").on("click",function(a){return a.preventDefault(),d.slideToggle("fast"),g.slideToggle("fast")}),d.on("change","input",function(){var c;return a(this).siblings(".wc-product-reviews-pro-validation-error").remove(),c=a(this)[0].files[0].type.match("image.*"),c?void 0:a(this).after('<span class="wc-product-reviews-pro-validation-error">'+b.options.i18n.file_not_allowed+"</span>")})})},b.prototype.initializeFieldToggler=function(){var b;return b=this,a(".form-contribution:not(.field-toggler-initialized)").each(function(){var c;return c=a(this).find('input[name="comment_type"]').val(),a(".star-rating-selector:not(.validate-required)").insertAfter("#review_comment_field"),b.options.comment_type!==c?(a(this).find(".form-row:not(:first)").hide(),a(this).find(".form-row:first").find("input, textarea, select").one("focus change",function(){var b,c;return b=a(this).closest("form"),c=b.find('input[name="comment_type"]').val(),"photo"!==c&&"video"!==c?b.find(".form-row:hidden:not(:contains(.input-hidden)):not(.attachment-source)").slideDown("fast"):"photo"===c?b.find(".form-row:hidden:not(:contains(.input-hidden)):not(.attachment-file)").slideDown("fast"):b.find(".form-row:hidden:not(:contains(.input-hidden))").slideDown("fast")}),a(this).addClass(".field-toggler-initialized")):void 0})},b.prototype.initializeValidation=function(){var b;return b=this,a("#reviews").on("submit",".form-contribution",function(c){var d,e,f,g,h,i;return c.preventDefault(),d=a(this),h=d.find('input[name="comment_type"]').val(),d.find(".wc-product-reviews-pro-validation-error").remove(),e=0,d.find("input,select,textarea").each(function(){var c,d,f,g,i,j,k;switch(f=a(this).attr("name"),k=a(this).val(),j=a(this).closest(".form-row").hasClass("validate-required"),j&&"review_rating"!==f&&!k&&(a(this).after('<span class="wc-product-reviews-pro-validation-error">'+b.options.i18n.error_required+"</span>"),e++),f){case h+"_comment":if(c=a(this),i=c.data("min-word-count"),g=c.data("max-word-count"),i||g){if(d=a.trim(c.val()).split(" ").length,i&&i>d)return c.after('<span class="wc-product-reviews-pro-validation-error">'+b.options.i18n.error_too_short.replace(/%d/g,i)+"</span>"),e++;if(g&&d>g)return c.after('<span class="wc-product-reviews-pro-validation-error">'+b.options.i18n.error_too_long.replace(/%d/g,g)+"</span>"),e++}}}),"photo"===h&&(i=d.find(".attachment-url input").val(),f=d.find(".attachment-file input").val(),i||f||(d.find(".attachment-url input").after('<span class="wc-product-reviews-pro-validation-error">'+b.options.i18n.error_attach_file+"</span>"),d.find(".attachment-file input").after('<span class="wc-product-reviews-pro-validation-error">'+b.options.i18n.error_attach_file+"</span>"))),e?void 0:(g=function(){return d.get(0).submit()},!b.options.is_user_logged_in&&b.options.comment_registration?b.showModal().one("login",function(){return g()}):g())})},b.prototype.initializeVoting=function(){var b;return b=this,a("#comments").on("click",".contribution-actions .vote",function(c){var d,e,f,g,h,i,j,k;return c.preventDefault(),g=a(this),j=g.hasClass("vote-down")?"negative":"positive",i=g.data("comment-id"),d=g.siblings(".feedback").html(""),f=g.siblings(".vote-count-positive"),e=g.siblings(".vote-count-negative"),k=a(this).hasClass("done"),h=function(){return a.ajax({type:"POST",url:b.options.ajax_url,data:{action:"wc_product_reviews_pro_vote",security:b.options.nonce,vote:j,comment_id:i},success:function(a){var c;return d.show(),setTimeout(function(){return d.fadeOut()},2e3),a.data&&a.data.message?(d.text(a.data.message),a.success?(d.removeClass("error"),f.text("("+a.data.positive_votes+")"),e.text("("+a.data.negative_votes+")"),g.removeClass("done").siblings(".vote").removeClass("done"),k||g.addClass("done"),c=a.data.positive_votes||a.data.negative_votes?b.options.i18n.comment_karma.replace("%1$d",a.data.positive_votes).replace("%2$d",a.data.total_votes):"",g.closest(".comment_container").find(".contribution-karma").text(c)):d.addClass("error")):d.text(b.options.i18n.vote_failed).addClass("error")}})},b.options.is_user_logged_in?h():b.showModal().one("login",function(){return h()})})},b.prototype.initializeModal=function(){var b,c,d;return d=this,this.$modal=b=a("#wc-product-reviews-pro-modal"),this.$overlay=c=a("#wc-product-reviews-pro-modal-overlay"),b.find("a.close").on("click",function(a){return a.preventDefault(),d.hideModal()}),b.find(".switcher a").on("click",function(c){return c.preventDefault(),a(this).closest(".switcher").find("p").toggle(),b.find(".col-1, .col-2").toggle()}),b.find("form.login").on("submit",function(b){var c;return b.preventDefault(),c=a(this),a.post(d.options.ajax_url,{username:a(this).find("#username").val(),password:a(this).find("#password").val(),_wpnonce:a(this).find("#_wpnonce").val(),login:1,_wc_product_reviews_pro_ajax_login:1},function(a){return d.handleModalAjaxResponse(a,c)})}),b.find("form.register").on("submit",function(b){var c;return b.preventDefault(),c=a(this),a.post(d.options.ajax_url,{email:a(this).find("#reg_email").val(),password:a(this).find("#reg_password").val(),register:a(this).find('input[name="register"]').val(),_wpnonce:a(this).find("#_wpnonce").val(),_wc_product_reviews_pro_ajax_register:!0},function(a){return d.handleModalAjaxResponse(a,c)})})},b.prototype.hideFlagForms=function(){return a(".contribution-flag-form").hide()},b.prototype.initializeFlagging=function(){var b;return b=this,this.hideFlagForms(),a("#comments").on("click",".contribution-actions .js-toggle-flag-form",function(b){var c;return b.preventDefault(),a(".flag-response").remove(),c=a(this).data("comment-id"),a("form#flag-contribution-"+c).slideDown("fast").find("button").removeProp("disabled")}),a("#reviews").on("submit",".contribution-flag-form",function(c){var d,e,f,g;return c.preventDefault(),e=a(this),e.find("button").attr("disabled",!0),d=e.siblings(".contribution-actions").find(".feedback").html(""),f=e.find('input[name="comment_id"]').val(),g=e.find('input[name="flag_reason"]').val(),a.ajax({type:"POST",url:b.options.ajax_url,data:{action:"wc_product_reviews_pro_flag",security:b.options.nonce,comment_id:f,reason:g},success:function(a){return e.slideUp("fast").find("button").removeAttr("disabled"),d.show(),setTimeout(function(){return d.fadeOut()},2e3),a.data&&a.data.message?(d.text(a.data.message),a.success?(d.removeClass("error"),e.prev(".comment_container").find(".js-toggle-flag-form").addClass("done")):d.addClass("error")):d.text(b.options.i18n.flag_failed).addClass("error")}})})},b.prototype.initializeTips=function(){return a(".js-tip").tipTip({attribute:"title",fadeIn:50,fadeOut:50,delay:200})},b.prototype.handleModalAjaxResponse=function(a,b){var c,d;return a.success?this.refreshNonce(function(a){return function(){return a.options.is_user_logged_in=!0,b.prevAll(".woocommerce-error").remove(),a.hideModal().trigger("login")}}(this)):(b.prevAll(".woocommerce-error").remove(),b.before(null!=(c=null!=a&&null!=(d=a.data)?d.message:void 0)?c:this.options.i18n.error_login_signup))},b.prototype.showModal=function(){var b,c,d;return d=this,b=this.$modal,c=this.$overlay,a(document).on("keydown.modal",function(a){return 27===a.keyCode?d.hideModal():void 0}),c.fadeIn(100).on("click.modal",function(){return d.hideModal()}),b.fadeIn(200),b.find(".col-1").show(),b.find(".col-2").hide(),b.trigger("showmodal")},b.prototype.hideModal=function(){return a(document).off("keydown.modal"),this.$overlay.hide().off("click.modal"),this.$modal.fadeOut(100),this.$modal.trigger("hidemodal")},b.prototype.refreshNonce=function(b){return a.get(this.options.ajax_url,{action:"wc_product_reviews_pro_refresh_nonce"}).done(function(a){return function(c){return a.options.nonce=c,b(c)}}(this))},b}(),a(window).load(function(){return new b(wc_product_reviews_pro)})}).call(this);
